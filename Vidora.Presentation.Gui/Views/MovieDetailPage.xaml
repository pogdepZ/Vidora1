<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Vidora.Presentation.Gui.Views.MovieDetailPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    x:Name="MovieDetailPageRoot">

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <!-- 1. Loading State: Thêm FallbackValue=True để hiện loading mặc định nếu VM chưa có -->
        <Grid Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Visible}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
                <ProgressRing IsActive="True" Width="56" Height="56"/>
                <TextBlock Text="Đang tải thông tin phim..." Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>
        </Grid>

        <!-- 2. Error State -->
        <Grid Visibility="{x:Bind ViewModel.HasError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Collapsed}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16" MaxWidth="400">
                <FontIcon Glyph="&#xE783;" FontSize="48" Foreground="#E50914"/>
                <TextBlock Text="Không thể tải thông tin phim" FontSize="18" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                <TextBlock Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay, FallbackValue='Lỗi không xác định'}"
                           TextWrapping="Wrap" TextAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                <Button Command="{x:Bind ViewModel.GoBackCommand}" HorizontalAlignment="Center" Padding="24,10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE72B;" FontSize="14"/>
                        <TextBlock Text="Quay lại"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <!-- 3. Content Section -->
        <ScrollViewer VerticalScrollMode="Enabled" VerticalScrollBarVisibility="Auto">
            <!-- Chỉ hiện khi IsLoading = False và HasError = False -->
            <Grid Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolNegationToVisibilityConverter}, FallbackValue=Collapsed}">
                <Grid Visibility="{x:Bind ViewModel.HasError, Mode=OneWay, Converter={StaticResource BoolNegationToVisibilityConverter}, FallbackValue=Collapsed}">
                    <StackPanel>
                        <Grid Height="400">
                            <!-- Image: Tránh null source -->
                            <Image Source="{x:Bind ViewModel.MoviePosterImage, Mode=OneWay}"
                                   Stretch="UniformToFill"
                                   Opacity="0.4"/>


                            <Border>
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                                        <GradientStop Color="Transparent" Offset="0"/>
                                        <GradientStop Color="{ThemeResource LayerFillColorDefault}" Offset="0.7"/>
                                        <GradientStop Color="{ThemeResource LayerFillColorDefault}" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                            </Border>

                            <Button Command="{x:Bind ViewModel.GoBackCommand}" HorizontalAlignment="Left" VerticalAlignment="Top"
                                    Margin="24,16" Width="40" Height="40" CornerRadius="20" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                                <FontIcon Glyph="&#xE72B;" FontSize="16"/>
                            </Button>

                            <Grid VerticalAlignment="Bottom" Padding="32,0,32,24">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" CornerRadius="8" Width="160" Height="240" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                                    <Grid>
                                        <Image Source="{x:Bind ViewModel.MoviePosterImage, Mode=OneWay}" Stretch="UniformToFill"/>

                                    </Grid>
                                </Border>

                                <StackPanel Grid.Column="1" Margin="24,0,0,0" VerticalAlignment="Bottom" Spacing="12">
                                    <TextBlock Text="{x:Bind ViewModel.MovieTitle, Mode=OneWay, FallbackValue='Đang tải...'}"
                                               FontSize="28" FontWeight="Bold" TextWrapping="Wrap" MaxLines="2"/>

                                    <StackPanel Orientation="Horizontal" Spacing="12">
                                        <Border Background="#E50914" CornerRadius="4" Padding="8,4">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE735;" FontSize="12" Foreground="White"/>
                                                <TextBlock Text="{x:Bind ViewModel.MovieAvgRating, Mode=OneWay, FallbackValue='0.0'}" FontWeight="SemiBold" Foreground="White"/>
                                            </StackPanel>
                                        </Border>
                                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="4" Padding="8,4">
                                            <TextBlock Text="{x:Bind ViewModel.MovieReleaseYear, Mode=OneWay, FallbackValue='----'}" FontWeight="SemiBold"/>
                                        </Border>
                                        <TextBlock Text="{x:Bind ViewModel.GenresDisplay, Mode=OneWay, FallbackValue=''}"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}" VerticalAlignment="Center"/>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,8,0,0">
                                        <Button Command="{x:Bind ViewModel.PlayMovieCommand}" Style="{StaticResource AccentButtonStyle}" Padding="20,10">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE768;" FontSize="16"/>
                                                <TextBlock Text="Xem phim" FontWeight="SemiBold"/>
                                            </StackPanel>
                                        </Button>
                                        <Button Command="{x:Bind ViewModel.PlayTrailerCommand}" Padding="20,10">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE714;" FontSize="16"/>
                                                <TextBlock Text="Trailer"/>
                                            </StackPanel>
                                        </Button>

                                        <!-- Nút Yêu thích -->
                                        <Button 
                                            Command="{x:Bind ViewModel.ToggleWatchlistCommand}" 
                                            Padding="20,10"
                                            IsEnabled="{x:Bind ViewModel.IsTogglingWatchlist, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <ProgressRing 
                                                    IsActive="True" 
                                                    Width="16" Height="16"
                                                    Visibility="{x:Bind ViewModel.IsTogglingWatchlist, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                <FontIcon 
                                                    Glyph="{x:Bind ViewModel.IsInWatchlist, Mode=OneWay, Converter={StaticResource BoolToHeartGlyphConverter}}" 
                                                    FontSize="16"
                                                    Foreground="{x:Bind ViewModel.IsInWatchlist, Mode=OneWay, Converter={StaticResource BoolToHeartColorConverter}}"
                                                    Visibility="{x:Bind ViewModel.IsTogglingWatchlist, Mode=OneWay, Converter={StaticResource BoolNegationToVisibilityConverter}}"/>
                                                <TextBlock Text="{x:Bind ViewModel.IsInWatchlist, Mode=OneWay, Converter={StaticResource BoolToWatchlistTextConverter}}"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Grid>

                        <StackPanel Padding="32,24" Spacing="24">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Nội dung" FontSize="18" FontWeight="SemiBold"/>
                                <TextBlock Text="{x:Bind ViewModel.MovieDescription, Mode=OneWay, FallbackValue='Chưa có mô tả.'}"
                                           TextWrapping="Wrap" LineHeight="24" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </StackPanel>

                            <StackPanel Spacing="8">
                                <TextBlock Text="Diễn viên" FontSize="18" FontWeight="SemiBold"/>
                                <TextBlock Text="{x:Bind ViewModel.ActorsDisplay, Mode=OneWay, FallbackValue='Đang cập nhật...'}"
                                           TextWrapping="Wrap" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </StackPanel>

                            <!-- Thông tin chi tiết bên dưới -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16" Margin="0,0,8,0">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Thể loại" FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                        <TextBlock Text="{x:Bind ViewModel.GenresDisplay, Mode=OneWay, FallbackValue='...'}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                </Border>
                                <Border Grid.Column="1" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16" Margin="4,0">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Năm" FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                        <TextBlock Text="{x:Bind ViewModel.MovieReleaseYear, Mode=OneWay, FallbackValue='----'}" FontWeight="SemiBold"/>
                                    </StackPanel>
                                </Border>
                                <Border Grid.Column="2" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16" Margin="8,0,0,0">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Đánh giá" FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <FontIcon Glyph="&#xE735;" FontSize="14" Foreground="#E50914"/>
                                            <TextBlock Text="{x:Bind ViewModel.MovieAvgRating, Mode=OneWay, FallbackValue='0'}" FontWeight="SemiBold"/>
                                            <TextBlock Text="/10" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Grid>
        </ScrollViewer>
    </Grid>
</Page>