<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Vidora.Presentation.Gui.Views.MovieDetailPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    x:Name="MovieDetailPageRoot">

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <!-- 1. Loading State -->
        <Grid Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Visible}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
                <ProgressRing IsActive="True" Width="56" Height="56"/>
                <TextBlock Text="Đang tải thông tin phim..." Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>
        </Grid>

        <!-- 2. Error State -->
        <Grid Visibility="{x:Bind ViewModel.HasError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Collapsed}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16" MaxWidth="400">
                <FontIcon Glyph="&#xE783;" FontSize="48" Foreground="#E50914"/>
                <TextBlock Text="Không thể tải thông tin phim" FontSize="18" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                <TextBlock Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay, FallbackValue='Lỗi không xác định'}"
                           TextWrapping="Wrap" TextAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
               
            </StackPanel>
        </Grid>

        <!-- 3. Content Section -->
        <ScrollViewer VerticalScrollMode="Enabled" VerticalScrollBarVisibility="Auto">
            <Grid Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolNegationToVisibilityConverter}, FallbackValue=Collapsed}">
                <Grid Visibility="{x:Bind ViewModel.HasError, Mode=OneWay, Converter={StaticResource BoolNegationToVisibilityConverter}, FallbackValue=Collapsed}">
                    <StackPanel>
                        <Grid Height="400">
                            <Image Source="{x:Bind ViewModel.MoviePosterImage, Mode=OneWay}"
                                   Stretch="UniformToFill"
                                   Opacity="0.4"/>

                            <Border>
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                                        <GradientStop Color="Transparent" Offset="0"/>
                                        <GradientStop Color="{ThemeResource LayerFillColorDefault}" Offset="0.7"/>
                                        <GradientStop Color="{ThemeResource LayerFillColorDefault}" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                            </Border>

                           

                            <Grid VerticalAlignment="Bottom" Padding="32,0,32,24">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" CornerRadius="8" Width="160" Height="240" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                                    <Grid>
                                        <Image Source="{x:Bind ViewModel.MoviePosterImage, Mode=OneWay}" Stretch="UniformToFill"/>
                                    </Grid>
                                </Border>

                                <StackPanel Grid.Column="1" Margin="24,0,0,0" VerticalAlignment="Bottom" Spacing="12">
                                    <TextBlock Text="{x:Bind ViewModel.MovieTitle, Mode=OneWay, FallbackValue='Đang tải...'}"
                                               FontSize="28" FontWeight="Bold" TextWrapping="Wrap" MaxLines="2"/>

                                    <StackPanel Orientation="Horizontal" Spacing="12">
                                        <Border Background="#E50914" CornerRadius="4" Padding="8,4">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE735;" FontSize="12" Foreground="White"/>
                                                <TextBlock Text="{x:Bind ViewModel.MovieAvgRating, Mode=OneWay, FallbackValue='0.0'}" FontWeight="SemiBold" Foreground="White"/>
                                            </StackPanel>
                                        </Border>
                                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="4" Padding="8,4">
                                            <TextBlock Text="{x:Bind ViewModel.MovieReleaseYear, Mode=OneWay, FallbackValue='----'}" FontWeight="SemiBold"/>
                                        </Border>
                                        <TextBlock Text="{x:Bind ViewModel.GenresDisplay, Mode=OneWay, FallbackValue=''}"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}" VerticalAlignment="Center"/>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,8,0,0">
                                        <Button Command="{x:Bind ViewModel.PlayMovieCommand}" Style="{StaticResource AccentButtonStyle}" Padding="20,10">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE768;" FontSize="16"/>
                                                <TextBlock Text="Xem phim" FontWeight="SemiBold"/>
                                            </StackPanel>
                                        </Button>
                                        <Button Command="{x:Bind ViewModel.PlayTrailerCommand}" Padding="20,10">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE714;" FontSize="16"/>
                                                <TextBlock Text="Trailer"/>
                                            </StackPanel>
                                        </Button>

                                        <!-- Nút Yêu thích -->
                                        <Button 
                                            Command="{x:Bind ViewModel.ToggleWatchlistCommand}" 
                                            Padding="20,10"
                                            IsEnabled="{x:Bind ViewModel.IsTogglingWatchlist, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <ProgressRing 
                                                    IsActive="True" 
                                                    Width="16" Height="16"
                                                    Visibility="{x:Bind ViewModel.IsTogglingWatchlist, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                <FontIcon 
                                                    Glyph="{x:Bind ViewModel.IsInWatchlist, Mode=OneWay, Converter={StaticResource BoolToHeartGlyphConverter}}" 
                                                    FontSize="16"
                                                    Foreground="{x:Bind ViewModel.IsInWatchlist, Mode=OneWay, Converter={StaticResource BoolToHeartColorConverter}}"
                                                    Visibility="{x:Bind ViewModel.IsTogglingWatchlist, Mode=OneWay, Converter={StaticResource BoolNegationToVisibilityConverter}}"/>
                                                <TextBlock Text="{x:Bind ViewModel.IsInWatchlist, Mode=OneWay, Converter={StaticResource BoolToWatchlistTextConverter}}"/>
                                            </StackPanel>
                                        </Button>

                                        <!-- Nút Đánh giá -->
                                        <Button 
                                            Command="{x:Bind ViewModel.OpenRatingPanelCommand}" 
                                            Padding="20,10"
                                            ToolTipService.ToolTip="Đánh giá phim">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE735;" FontSize="16" Foreground="#FFD700"/>
                                                <TextBlock Text="Đánh giá"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>

                                    <!-- Hiển thị đánh giá của user nếu đã đánh giá -->
                                    <StackPanel 
                                        Orientation="Horizontal" 
                                        Spacing="8"
                                        Visibility="{x:Bind ViewModel.UserRating, Mode=OneWay, Converter={StaticResource IntToVisibilityConverter}, FallbackValue=Collapsed}">
                                        <TextBlock Text="Đánh giá của bạn:" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <FontIcon Glyph="&#xE735;" FontSize="14" Foreground="#FFD700"/>
                                        <TextBlock FontWeight="SemiBold" Foreground="#FFD700">
                                            <Run Text="{x:Bind ViewModel.UserRating, Mode=OneWay}"/>
                                            <Run Text="/10"/>
                                        </TextBlock>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Grid>

                        <StackPanel Padding="32,24" Spacing="24">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Nội dung" FontSize="18" FontWeight="SemiBold"/>
                                <TextBlock Text="{x:Bind ViewModel.MovieDescription, Mode=OneWay, FallbackValue='Chưa có mô tả.'}"
                                           TextWrapping="Wrap" LineHeight="24" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </StackPanel>

                            <StackPanel Spacing="8">
                                <TextBlock Text="Diễn viên" FontSize="18" FontWeight="SemiBold"/>
                                <TextBlock Text="{x:Bind ViewModel.ActorsDisplay, Mode=OneWay, FallbackValue='Đang cập nhật...'}"
                                           TextWrapping="Wrap" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </StackPanel>

                            <!-- Thông tin chi tiết -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16" Margin="0,0,8,0">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Thể loại" FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                        <TextBlock Text="{x:Bind ViewModel.GenresDisplay, Mode=OneWay, FallbackValue='...'}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                </Border>
                                <Border Grid.Column="1" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16" Margin="4,0">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Năm" FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                        <TextBlock Text="{x:Bind ViewModel.MovieReleaseYear, Mode=OneWay, FallbackValue='----'}" FontWeight="SemiBold"/>
                                    </StackPanel>
                                </Border>
                                <Border Grid.Column="2" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16" Margin="8,0,0,0">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Đánh giá" FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <FontIcon Glyph="&#xE735;" FontSize="14" Foreground="#E50914"/>
                                            <TextBlock Text="{x:Bind ViewModel.MovieAvgRating, Mode=OneWay, FallbackValue='0'}" FontWeight="SemiBold"/>
                                            <TextBlock Text="/10" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Grid>
        </ScrollViewer>

        <!-- 4. Rating Panel Overlay -->
        <Grid 
            Visibility="{x:Bind ViewModel.ShowRatingPanel, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
            Background="#80000000">
            
            <!-- Click outside to close -->
            <Button 
                Command="{x:Bind ViewModel.CloseRatingPanelCommand}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                Background="Transparent"
                BorderThickness="0"/>

            <!-- Rating Dialog -->
            <Border 
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="16"
                Padding="32"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                MinWidth="480">
                <StackPanel Spacing="24">
                    <!-- Header -->
                    <StackPanel Spacing="8">
                        <TextBlock 
                            Text="Đánh giá phim" 
                            FontSize="24" 
                            FontWeight="Bold"
                            HorizontalAlignment="Center"/>
                        <TextBlock 
                            Text="{x:Bind ViewModel.MovieTitle, Mode=OneWay}"
                            FontSize="14"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            HorizontalAlignment="Center"
                            TextTrimming="CharacterEllipsis"
                            MaxLines="1"/>
                    </StackPanel>

                    <!-- 10 Stars -->
                    <StackPanel HorizontalAlignment="Center" Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                            <!-- Star 1 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="1"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="1">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star1"/>
                            </Button>
                            <!-- Star 2 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="2"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="2">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star2"/>
                            </Button>
                            <!-- Star 3 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="3"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="3">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star3"/>
                            </Button>
                            <!-- Star 4 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="4"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="4">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star4"/>
                            </Button>
                            <!-- Star 5 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="5"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="5">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star5"/>
                            </Button>
                            <!-- Star 6 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="6"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="6">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star6"/>
                            </Button>
                            <!-- Star 7 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="7"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="7">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star7"/>
                            </Button>
                            <!-- Star 8 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="8"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="8">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star8"/>
                            </Button>
                            <!-- Star 9 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="9"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="9">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star9"/>
                            </Button>
                            <!-- Star 10 -->
                            <Button 
                                Command="{x:Bind ViewModel.SelectStarCommand}" 
                                CommandParameter="10"
                                Padding="4" Background="Transparent" BorderThickness="0"
                                PointerEntered="Star_PointerEntered" PointerExited="Star_PointerExited" Tag="10">
                                <FontIcon Glyph="&#xE735;" FontSize="32" x:Name="Star10"/>
                            </Button>
                        </StackPanel>

                        <!-- Rating Display -->
                        <TextBlock 
                            HorizontalAlignment="Center"
                            FontSize="20"
                            FontWeight="SemiBold">
                            <Run Text="{x:Bind ViewModel.SelectedRating, Mode=OneWay}"/>
                            <Run Text="/10 sao" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- Buttons -->
                    <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                        <Button 
                            Command="{x:Bind ViewModel.CloseRatingPanelCommand}"
                            Padding="24,10"
                            MinWidth="100">
                            <TextBlock Text="Hủy"/>
                        </Button>
                        <Button 
                            Command="{x:Bind ViewModel.SubmitRatingCommand}"
                            Style="{StaticResource AccentButtonStyle}"
                            Padding="24,10"
                            MinWidth="140"
                            IsEnabled="{x:Bind ViewModel.IsSubmittingRating, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}">
                            <StackPanel Orientation="Horizontal" Spacing="8"> 
                                <ProgressRing 
                                    IsActive="True" 
                                    Width="16" Height="16"
                                    Visibility="{x:Bind ViewModel.IsSubmittingRating, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                <TextBlock Text="Gửi đánh giá" FontWeight="SemiBold"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Page>
