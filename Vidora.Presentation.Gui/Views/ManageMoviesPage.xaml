<Page
    x:Class="Vidora.Presentation.Gui.Views.ManageMoviesPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Vidora.Presentation.Gui.Views"
    xmlns:viewModels="using:Vidora.Presentation.Gui.ViewModels"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid Background="Transparent" Margin="0 20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- ===== INFOBAR THÔNG BÁO ===== -->
        <InfoBar Grid.Row="0"
                 Grid.RowSpan="4"
                 VerticalAlignment="Top"
                 HorizontalAlignment="Center"
                 Margin="0,10,0,0"
                 Canvas.ZIndex="999"
                 IsOpen="{x:Bind ViewModel.IsInfoBarOpen, Mode=TwoWay}"
                 IsClosable="True"
                 Severity="{x:Bind ViewModel.InfoBarSeverity, Mode=OneWay}"
                 Title="{x:Bind ViewModel.InfoBarTitle, Mode=OneWay}"
                 Message="{x:Bind ViewModel.InfoBarMessage, Mode=OneWay}"
                 Width="500"/>

        <!-- ===== HEADER ===== -->
        <Grid Grid.Row="0" Padding="40,30,40,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Spacing="10">
                <TextBlock Text="Library"
                           FontSize="30"
                           FontWeight="SemiBold"/>
            </StackPanel>

            <!-- Buttons: Import + Add new movie -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12">
                <!-- Import Excel Button (demo) -->
                <Button Command="{x:Bind ViewModel.ImportExcelCommand}"
                        Padding="20,10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8B5;" FontSize="14"/>
                        <TextBlock Text="Import Excel" FontWeight="SemiBold"/>
                    </StackPanel>
                </Button>

                <!-- Add new movie Button (demo) -->
                <Button Command="{x:Bind ViewModel.AddMovieCommand}"
                        Padding="20,10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE710;" FontSize="14"/>
                        <TextBlock Text="Add New Movie" FontWeight="SemiBold"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <!-- ===== IMPORT PROGRESS SECTION (ẩn mặc định) ===== -->
        <Border x:Name="ImportSection"
                Grid.Row="1"
                Margin="40,0,40,20"
                Padding="20"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="12"
                BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                BorderThickness="1"
                Visibility="{x:Bind ViewModel.IsImportVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel Spacing="12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel>
                        <TextBlock Text="Importing Movies from Excel" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Text="{x:Bind ViewModel.ImportStatusText, Mode=OneWay}"
                                   Foreground="Gray"
                                   FontSize="12"
                                   Margin="0,4,0,0"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="20"
                                VerticalAlignment="Center">
                        <StackPanel>
                            <TextBlock Text="Success" Foreground="Gray" FontSize="11" HorizontalAlignment="Center"/>
                            <TextBlock Text="{x:Bind ViewModel.ImportSuccessCount, Mode=OneWay}"
                                       Foreground="#46D369"
                                       FontWeight="Bold"
                                       FontSize="18"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Failed" Foreground="Gray" FontSize="11" HorizontalAlignment="Center"/>
                            <TextBlock Text="{x:Bind ViewModel.ImportFailedCount, Mode=OneWay}"
                                       Foreground="#D81F26"
                                       FontWeight="Bold"
                                       FontSize="18"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Total" Foreground="Gray" FontSize="11" HorizontalAlignment="Center"/>
                            <TextBlock FontWeight="Bold" FontSize="18" HorizontalAlignment="Center">
                                <Run Text="{x:Bind ViewModel.ImportCurrentRun, Mode=OneWay}"/>
                                <Run Text="/"/>
                                <Run Text="{x:Bind ViewModel.ImportTotalRun, Mode=OneWay}"/>
                            </TextBlock>
                        </StackPanel>
                    </StackPanel>
                </Grid>

                <ProgressBar Value="{x:Bind ViewModel.ImportProgress, Mode=OneWay}"
                             Maximum="100"
                             Height="8"
                             CornerRadius="4"/>
            </StackPanel>
        </Border>

        <!-- ===== FILTER SECTION ===== -->
        <Border Grid.Row="2"
                Margin="40,0,40,20"
                Padding="20"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="12"
                BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                BorderThickness="1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Search by Title -->
                <AutoSuggestBox x:Name="SearchBox"
                                Grid.Column="0"
                                PlaceholderText="Search by movie title..."
                                QueryIcon="Find"
                                MinWidth="280"
                                VerticalAlignment="Center"
                                Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                QuerySubmitted="OnSearchQuerySubmitted"/>

                <!-- Genre Filter -->
                <ComboBox x:Name="GenreCombo"
                          Grid.Column="1"
                          Margin="16,0,0,0"
                          MinWidth="180"
                          PlaceholderText="Genre"
                          VerticalAlignment="Center"
                          ItemsSource="{x:Bind ViewModel.Genres, Mode=OneWay}"
                          SelectedItem="{x:Bind ViewModel.SelectedGenre, Mode=TwoWay}"
                          DisplayMemberPath="Name"/>

                <!-- Release Year Filter -->
                <TextBox x:Name="ReleaseYearBox"
                         Grid.Column="2"
                         Margin="16,0,0,0"
                         Width="120"
                         PlaceholderText="Release Year"
                         VerticalAlignment="Center"
                         Text="{x:Bind ViewModel.ReleaseYearText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         InputScope="Number"/>

                <!-- Search Button -->
                <Button Grid.Column="3"
                        Margin="16,0,0,0"
                        VerticalAlignment="Center"
                        Command="{x:Bind ViewModel.SearchCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE721;" FontSize="14"/>
                        <TextBlock Text="Search"/>
                    </StackPanel>
                </Button>

                <!-- Clear Filters Button -->
                <Button Grid.Column="4"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center"
                        ToolTipService.ToolTip="Clear Filters"
                        Command="{x:Bind ViewModel.ClearFiltersCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE894;" FontSize="14"/>
                        <TextBlock Text="Clear"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- ===== CONTENT ===== -->
        <Border Grid.Row="3"
                Margin="40,0,40,40"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="12"
                BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                BorderThickness="1">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="48"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- ===== TABLE HEADER ===== -->
                <Grid Grid.Row="0"
                      Padding="30,10"
                      BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                      BorderThickness="0,0,0,1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="3*"/>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="MOVIE" FontWeight="Bold" Foreground="Gray"/>
                    <TextBlock Grid.Column="1" Text="GENRE" FontWeight="Bold" Foreground="Gray" HorizontalAlignment="Center"/>
                    <TextBlock Grid.Column="2" Text="DIRECTOR" FontWeight="Bold" Foreground="Gray" HorizontalAlignment="Center"/>
                    <TextBlock Grid.Column="3" Text="ACTION" FontWeight="Bold" Foreground="Gray" HorizontalAlignment="Center"/>
                </Grid>

                <!-- ===== LIST ===== -->
                <ListView ItemsSource="{x:Bind ViewModel.Movies, Mode=OneWay}"
                          Grid.Row="1"
                          SelectionMode="None"
                          Padding="0">
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="viewModels:MovieRow">
                            <Grid Padding="20,14">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="3*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- MOVIE -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="14">
                                    <Border Width="44" Height="64" CornerRadius="6">
                                        <Image Source="{x:Bind PosterUrl}" Stretch="UniformToFill"/>
                                    </Border>

                                    <StackPanel VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind Title}"
                                                   FontWeight="SemiBold"
                                                   FontSize="14"/>
                                        <TextBlock Text="{x:Bind ReleaseYear}"
                                                   Foreground="Gray"
                                                   FontSize="12"/>
                                    </StackPanel>
                                </StackPanel>

                                <!-- GENRE -->
                                <TextBlock Grid.Column="1"
                                           Text="{x:Bind GenresText}"
                                           VerticalAlignment="Center"
                                           Foreground="Gray"
                                           HorizontalAlignment="Center"/>

                                <!-- DIRECTOR (API list movies chưa trả -> để trống/tạm) -->
                                <TextBlock Grid.Column="2"
                                           Text="{x:Bind DirectorName}"
                                           Foreground="Gray"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"/>

                                <!-- ACTION -->
                                <StackPanel Grid.Column="3"
                                            Orientation="Horizontal"
                                            Spacing="10"
                                            VerticalAlignment="Center"
                                            HorizontalAlignment="Center">
                                    <Button Command="{x:Bind ViewModel.ViewEditCommand, ElementName=PageRoot}"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            ToolTipService.ToolTip="View Details / Edit"
                                            CommandParameter="{x:Bind MovieId}">
                                        <FontIcon Glyph="&#xE70F;" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                                    </Button>
                                    <Button Command="{x:Bind ViewModel.ToggleDeleteCommand, ElementName=PageRoot}"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            ToolTipService.ToolTip="Delete Movie"
                                            CommandParameter="{x:Bind MovieId}">
                                        <FontIcon Glyph="&#xE74D;" Foreground="Red" />
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <!-- ===== LOADING ===== -->
                <ProgressRing
                              Grid.Row="1"
                              IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"/>

                <!-- ===== PAGINATION ===== -->
                <StackPanel Grid.Row="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Spacing="12"
                            Padding="20">
                    <Button Content="◀"
                            Command="{x:Bind ViewModel.PrevCommand}"
                            IsEnabled="{x:Bind ViewModel.CanPrev, Mode=OneWay}"/>
                    <TextBlock VerticalAlignment="Center">
                        <Run Text="Page "/>
                        <Run Text="{x:Bind ViewModel.CurrentPage, Mode=OneWay}" FontWeight="Bold"/>
                        <Run Text=" / "/>
                        <Run Text="{x:Bind ViewModel.TotalPages, Mode=OneWay}" FontWeight="Bold"/>
                    </TextBlock>
                    <Button Content="▶"
                            Command="{x:Bind ViewModel.NextCommand}"
                            IsEnabled="{x:Bind ViewModel.CanNext, Mode=OneWay}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
